{% extends 'base.html' %}
{% block title %}Rejestracja – AK{% endblock %}

{% block content %}
<div class="register">
  <div class="register__card">
    <div class="register__card-body">
      <h2 class="register__title">Zarejestruj się</h2>

      <form method="POST" id="registerForm">
        {{ form.hidden_tag() }}

        <div class="register__field">
          <label>Typ konta:</label><br>
          {% for subfield in form.role %}
          <div class="register__role-option">
            {{ subfield(class="register__role-input") }}
            <label>{{ subfield.label.text }}</label>
          </div>
          {% endfor %}
        </div>

        <div class="register__field">
          {{ form.name.label }}
          {{ form.name(class="register__input", placeholder="Imię") }}
        </div>

        <div class="register__field">
          {{ form.surname.label }}
          {{ form.surname(class="register__input", placeholder="Nazwisko") }}
        </div>

        <div class="register__field">
          {{ form.email.label }}
          {{ form.email(class="register__input", placeholder="E-mail", id="emailInput") }}

          <div id="emailFeedback" style="display:none; color: red;">
            Ten adres e-mail jest już zajęty.
          </div>
        </div>
        

        <div class="register__field">
          {{ form.password.label }}
          {{ form.password(class="register__input", placeholder="Hasło") }}
        </div>

        <div class="register__field" id="subject_field">
          {{ form.subject.label }}
          {{ form.subject(class="register__select") }}
        </div>

        <div class="register__submit">
          {{ form.submit(class="register__btn") }}
        </div>
      </form>

      <p class="register__login-link">
        Masz już konto? <a href="{{ url_for('login') }}">Zaloguj się</a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function toggleSubject() {
    const role = document.querySelector('input[name="role"]:checked').value;
    document.getElementById("subject_field").style.display = role === "teacher" ? "block" : "none";
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('input[name="role"]').forEach(el =>
      el.addEventListener("change", toggleSubject)
    );
    toggleSubject();
  });

  document.addEventListener("DOMContentLoaded", function () {
    const emailInput = document.getElementById("emailInput");
    const feedback = document.getElementById("emailFeedback");
    const form = document.getElementById("registerForm");
    let emailTaken = false;

    emailInput.addEventListener("input", async () => {
      const email = emailInput.value.trim();

      if (email.length < 3) {
        feedback.style.display = "none";
        emailTaken = false;
        return;
      }

      const res = await fetch(`/check_email?email=${encodeURIComponent(email)}`);
      const data = await res.json();

      if (data.exists) {
        feedback.style.display = "block";
        emailTaken = true;
      } else {
        feedback.style.display = "none";
        emailTaken = false;
      }
    });

    form.addEventListener("submit", (e) => {
      if (emailTaken) {
        e.preventDefault();
      }
    });
  });

</script>
{% endblock %}